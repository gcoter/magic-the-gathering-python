vars:
  - n_games_for_collection: 1000
  - n_games_for_evaluation: 1000
  - params_path: params.yaml
  - game_logs_dataset_path: data/game_logs_dataset.pickle
  - model_folder_path: results/models/
  - collect_data_metrics_path: results/metrics/collect_data.json
  - game_logs_stats_after_data_collection_path: results/metrics/game_logs_stats_after_data_collection.json
  - evaluate_deep_learning_player_metrics_path: results/metrics/evaluate_deep_learning_player.json
  - game_logs_stats_after_evaluation_path: results/metrics/game_logs_stats_after_evaluation.json

stages:
  collect_data:
    cmd: >
      python scripts/run_competition_between_players.py
      --n_games ${n_games_for_collection}
      --player_classes random,random
      --params_path ${params_path}
      --game_logs_dataset_path ${game_logs_dataset_path}
      --evaluation_metrics_json_path ${collect_data_metrics_path}
    deps:
      - data/basic_land_cards.csv
      - data/vanilla_creature_cards.csv
      - magic_the_gathering/actions/base.py
      - magic_the_gathering/actions/cast_card.py
      - magic_the_gathering/actions/deal_damage.py
      - magic_the_gathering/actions/declare_attacker.py
      - magic_the_gathering/actions/declare_blocker.py
      - magic_the_gathering/actions/draw.py
      - magic_the_gathering/actions/kill_player.py
      - magic_the_gathering/actions/move_to_graveyard.py
      - magic_the_gathering/actions/none.py
      - magic_the_gathering/actions/pass_to_next_player.py
      - magic_the_gathering/actions/play_land.py
      - magic_the_gathering/actions/resolve_stack.py
      - magic_the_gathering/actions/shuffle.py
      - magic_the_gathering/actions/tap.py
      - magic_the_gathering/actions/untap.py
      - magic_the_gathering/cards/base.py
      - magic_the_gathering/cards/deck_creator.py
      - magic_the_gathering/cards/state.py
      - magic_the_gathering/game_modes/base.py
      - magic_the_gathering/game_modes/default.py
      - magic_the_gathering/phases/base.py
      - magic_the_gathering/phases/beginning.py
      - magic_the_gathering/phases/combat_beginning.py
      - magic_the_gathering/phases/combat_damage.py
      - magic_the_gathering/phases/combat_declare_attackers.py
      - magic_the_gathering/phases/combat_declare_blockers.py
      - magic_the_gathering/phases/combat_end.py
      - magic_the_gathering/phases/draw.py
      - magic_the_gathering/phases/end.py
      - magic_the_gathering/phases/main.py
      - magic_the_gathering/phases/mulligan.py
      - magic_the_gathering/phases/players_get_priority.py
      - magic_the_gathering/phases/untap.py
      - magic_the_gathering/phases/upkeep.py
      - magic_the_gathering/players/base.py
      - magic_the_gathering/players/random.py
      - magic_the_gathering/game_engine.py
      - magic_the_gathering/game_logs_dataset.py
      - magic_the_gathering/game_state.py
      - magic_the_gathering/turn.py
      - scripts/run_competition_between_players.py
    outs:
      - ${game_logs_dataset_path}
    metrics:
      - ${collect_data_metrics_path}:
          cache: false
  compute_game_logs_stats:
    cmd: >
      python scripts/compute_game_logs_stats.py
      --game_logs_dataset_path ${game_logs_dataset_path}
      --metrics_json_path ${game_logs_stats_after_data_collection_path}
    deps:
      - magic_the_gathering/actions/base.py
      - magic_the_gathering/game_logs_dataset.py
      - scripts/compute_game_logs_stats.py
      - ${game_logs_dataset_path}
    metrics:
      - ${game_logs_stats_after_data_collection_path}:
          cache: false
  train_deep_learning_scorer:
    cmd: >
      python scripts/train_deep_learning_scorer.py
      --params_path ${params_path}
      --game_logs_dataset_path ${game_logs_dataset_path}
      --model_folder_path ${model_folder_path}
      --model_file_name deep_learning_scorer
    deps:
      - magic_the_gathering/game_logs_dataset.py
      - magic_the_gathering/players/deep_learning_based/single_action_scorer/models/base.py
      - magic_the_gathering/players/deep_learning_based/single_action_scorer/models/v2.py
      - magic_the_gathering/players/deep_learning_based/single_action_scorer/dataset.py
      - scripts/train_deep_learning_scorer.py
      - ${game_logs_dataset_path}
    params:
      - ${params_path}:
          - deep_learning_scorer
    outs:
      - ${model_folder_path}/deep_learning_scorer.ckpt
  evaluate_deep_learning_player:
    cmd: >
      python scripts/run_competition_between_players.py
      --n_games ${n_games_for_evaluation}
      --player_classes random,deep_learning
      --params_path ${params_path}
      --evaluation_metrics_json_path ${evaluate_deep_learning_player_metrics_path}
      --game_logs_stats_json_path ${game_logs_stats_after_evaluation_path}
      --deep_learning_scorer_path ${model_folder_path}/deep_learning_scorer.ckpt
    deps:
      - data/basic_land_cards.csv
      - data/vanilla_creature_cards.csv
      - magic_the_gathering/actions/base.py
      - magic_the_gathering/actions/cast_card.py
      - magic_the_gathering/actions/deal_damage.py
      - magic_the_gathering/actions/declare_attacker.py
      - magic_the_gathering/actions/declare_blocker.py
      - magic_the_gathering/actions/draw.py
      - magic_the_gathering/actions/kill_player.py
      - magic_the_gathering/actions/move_to_graveyard.py
      - magic_the_gathering/actions/none.py
      - magic_the_gathering/actions/pass_to_next_player.py
      - magic_the_gathering/actions/play_land.py
      - magic_the_gathering/actions/resolve_stack.py
      - magic_the_gathering/actions/shuffle.py
      - magic_the_gathering/actions/tap.py
      - magic_the_gathering/actions/untap.py
      - magic_the_gathering/cards/base.py
      - magic_the_gathering/cards/deck_creator.py
      - magic_the_gathering/cards/state.py
      - magic_the_gathering/game_modes/base.py
      - magic_the_gathering/game_modes/default.py
      - magic_the_gathering/phases/base.py
      - magic_the_gathering/phases/beginning.py
      - magic_the_gathering/phases/combat_beginning.py
      - magic_the_gathering/phases/combat_damage.py
      - magic_the_gathering/phases/combat_declare_attackers.py
      - magic_the_gathering/phases/combat_declare_blockers.py
      - magic_the_gathering/phases/combat_end.py
      - magic_the_gathering/phases/draw.py
      - magic_the_gathering/phases/end.py
      - magic_the_gathering/phases/main.py
      - magic_the_gathering/phases/mulligan.py
      - magic_the_gathering/phases/players_get_priority.py
      - magic_the_gathering/phases/untap.py
      - magic_the_gathering/phases/upkeep.py
      - magic_the_gathering/players/base.py
      - magic_the_gathering/players/deep_learning_based/player.py
      - magic_the_gathering/players/deep_learning_based/base_scorer.py
      - magic_the_gathering/players/deep_learning_based/single_action_scorer/models/base.py
      - magic_the_gathering/players/deep_learning_based/single_action_scorer/models/v2.py
      - magic_the_gathering/players/deep_learning_based/single_action_scorer/dataset.py
      - magic_the_gathering/game_engine.py
      - magic_the_gathering/game_logs_dataset.py
      - magic_the_gathering/game_state.py
      - magic_the_gathering/turn.py
      - scripts/run_competition_between_players.py
      - ${model_folder_path}/deep_learning_scorer.ckpt
    params:
      - ${params_path}:
          - deep_learning_scorer
    metrics:
      - ${evaluate_deep_learning_player_metrics_path}:
          cache: false
      - ${game_logs_stats_after_evaluation_path}:
          cache: false
